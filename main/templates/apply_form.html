<div class="container" style="padding: 20px; background: white; min-height: 100vh; font-family: 'Pretendard', sans-serif;">
  <h2 id="displayPolicyName" style="font-size: 16px; color: #8e8ffa; margin-bottom: 4px; font-weight: 500;">ì •ì±… ì •ë³´ë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...</h2>
  <h2 style="font-size: 22px; font-weight: bold; margin-bottom: 24px; color: #1a202c;">ğŸ“ <span id="displayDocName">ì„œë¥˜</span> ì‘ì„±</h2>

  <div id="dynamicFields">
    <div id="loadingStatus" style="text-align: center; padding: 60px 0;">
      <p style="color: #a0aec0; font-size: 15px; margin-bottom: 8px;">AIê°€ ì„œë¥˜ í•­ëª©ì— ë§ëŠ” ë§ì¶¤í˜• ì§ˆë¬¸ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
      <div style="display: inline-block; width: 24px; height: 24px; border: 3px solid #edf2f7; border-top-color: #8e8ffa; border-radius: 50%; animation: spin 1s linear infinite;"></div>
    </div>
  </div>

  <button onclick="window.history.back()" style="width: 100%; background: #a8e6cf; color: white; border: none; padding: 18px; border-radius: 20px; font-weight: bold; font-size: 16px; margin-top: 30px; cursor: pointer;">
    ì‘ì„± ì™„ë£Œ
  </button>
</div>

<style>
@keyframes spin { to { transform: rotate(360deg); } }
input[type="text"] { box-sizing: border-box !important; }
.field-group { opacity: 0; animation: fadeIn 0.5s forwards; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const docName = urlParams.get('doc');
    const policyId = urlParams.get('id'); 
    const container = document.getElementById('dynamicFields');

    if (docName) document.getElementById('displayDocName').innerText = docName;

    if (!policyId) {
        container.innerHTML = "<p style='text-align:center; color:#e53e3e; padding: 40px;'>âš ï¸ ì •ì±… IDê°€ ì—†ìŠµë‹ˆë‹¤. ëª©ë¡ì—ì„œ ë‹¤ì‹œ ì§„ì…í•´ì£¼ì„¸ìš”.</p>";
        return;
    }

    const apiUrl = `/api/get_form_fields/?id=${policyId}&doc=${encodeURIComponent(docName || 'ì‹ ì²­ì„œ')}`;
    
    fetch(apiUrl)
        .then(res => {
            if (!res.ok) throw new Error(`HTTP ì—ëŸ¬! ìƒíƒœì½”ë“œ: ${res.status}`);
            return res.json();
        })
        .then(data => {
            container.innerHTML = ''; 

            if (!data.fields || data.fields.length === 0) {
                container.innerHTML = "<p style='text-align:center; color:#718096; padding: 40px;'>í•­ëª©ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br><small style='color:#cbd5e0;'>ì„œë²„ ì‘ë‹µì„ í™•ì¸í•´ì£¼ì„¸ìš”.</small></p>";
                return;
            }

            if (data.policy_name) {
                document.getElementById('displayPolicyName').innerText = data.policy_name;
            }

            data.fields.forEach(field => {
                const questionsHtml = (field.questions || ["ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."]).map((q) => `
                    <div style="margin-bottom: 20px; text-align: left;">
                        <p style="font-size: 14px; color: #4a5568; margin-bottom: 8px; font-weight: 600;">Q. ${q}</p>
                        <input type="text" 
                               class="${field.id}-answer" 
                               placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”" 
                               style="width: 100%; min-height: 48px; padding: 12px; border: 1px solid #edf2f7; border-radius: 12px; font-size: 14px; outline: none; display: block; background: #ffffff;">
                    </div>
                `).join('');

                const sectionHtml = `
                    <div class="field-group" style="margin-bottom: 35px; border-bottom: 2px solid #f7fafc; padding-bottom: 25px;">
                        <label style="font-weight: bold; font-size: 18px; color: #2d3748; display: block; margin-bottom: 15px; text-align: left;">${field.label}</label>
                        <div style="background: #f8fafc; padding: 20px; border-radius: 15px; margin-bottom: 15px;">
                            ${questionsHtml}
                            <button type="button" onclick="generateDraft(event, '${field.id}', '${field.label}')" 
                                    style="margin-top: 10px; background: #8e8ffa; color: white; border: none; padding: 16px; border-radius: 12px; cursor: pointer; width: 100%; font-weight: 600;">
                                ğŸª„ ë‹µë³€ì„ ë¬¸ì¥ìœ¼ë¡œ ë§Œë“¤ê¸°
                            </button>
                        </div>
                        <textarea id="${field.id}" placeholder="AI ì´ˆì•ˆì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤." 
                                  style="width: 100%; height: 180px; border: 1px solid #e2e8f0; border-radius: 15px; padding: 18px; font-family: inherit; line-height: 1.6; display: none; outline: none; box-sizing: border-box;"></textarea>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', sectionHtml);
            });
        })
        .catch(err => {
            console.error("ì—ëŸ¬ ë°œìƒ:", err);
            container.innerHTML = `<p style='text-align:center; color:#e53e3e; padding: 40px;'>ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ${err.message}</p>`;
        });
});

function generateDraft(event, fieldId, label) {
    const answers = Array.from(document.querySelectorAll(`.${fieldId}-answer`))
                         .map(input => input.value)
                         .filter(val => val.trim() !== "");

    if (answers.length === 0) {
        alert("ìµœì†Œ í•˜ë‚˜ ì´ìƒì˜ ì§ˆë¬¸ì— ë‹µë³€ì„ ì ì–´ì£¼ì„¸ìš”!");
        return;
    }

    const btn = event.target;
    const originalText = btn.innerText;
    btn.innerText = "â³ ìƒì„± ì¤‘...";
    btn.disabled = true;

    const urlParams = new URLSearchParams(window.location.search);
    const policyId = urlParams.get('id');

    fetch('/api/ai_generate_motivation/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            policy_id: policyId,
            doc_name: urlParams.get('doc'),
            section_name: label,
            answers: answers 
        })
    })
    .then(res => res.json())
    .then(data => {
        const textarea = document.getElementById(fieldId);
        if (data.status === "success") {
            textarea.style.display = 'block';
            textarea.value = data.result;
            textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
            alert("ìƒì„± ì‹¤íŒ¨: " + data.message);
        }
    })
    .catch(() => alert("í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."))
    .finally(() => {
        btn.innerText = originalText;
        btn.disabled = false;
    });
}
</script>