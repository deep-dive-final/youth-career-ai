{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì„œë¥˜ ì‘ì„±</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body style="background-color: #f8f9fa; font-family: 'Pretendard', sans-serif; margin: 0; padding: 20px;">

    <div class="container" style="max-width: 480px; margin: 0 auto; padding-bottom: 100px;">
        <div style="display: flex; align-items: center; margin-bottom: 25px;">
            <button onclick="history.back()" style="border: none; background: none; cursor: pointer; padding: 10px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
            </button>
            <h2 id="displayDocName" style="font-size: 20px; margin: 0; margin-left: 10px;">ì„œë¥˜ ì‘ì„±</h2>
        </div>

        <div id="dynamicFields">
            <p id="loadingMsg" style="text-align: center; color: #718096; padding: 50px 0;">í•­ëª©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>

        <div style="position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; padding: 20px; background: white; box-sizing: border-box; box-shadow: 0 -4px 12px rgba(0,0,0,0.05);">
            <button id="mainSubmitBtn" onclick="submitApplication()" style="width: 100%; background: #8e8ffa; color: white; border: none; padding: 18px; border-radius: 16px; font-size: 16px; font-weight: bold; cursor: pointer;">
                ì‘ì„± ì™„ë£Œ ë° ì €ì¥
            </button>
        </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const docName = urlParams.get('doc');
    const policyId = urlParams.get('id'); 
    const container = document.getElementById('dynamicFields');
    const titleElem = document.getElementById('displayDocName');

    if (titleElem && docName) titleElem.innerText = docName;

    if (!policyId) {
        if (container) container.innerHTML = "<p>âš ï¸ ì •ì±… ì •ë³´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.</p>";
        return;
    }

    fetch(`/api/get_saved_document/?id=${policyId}&doc=${encodeURIComponent(docName)}`)
        .then(res => res.json())
        .then(data => {
            if (data.status === "success") {
                container.innerHTML = `
                    <div style="background: white; border-radius: 24px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
                        <label style="font-weight: bold; font-size: 18px; color: #2d3748; display: block; margin-bottom: 15px;">ì´ì „ì— ì‘ì„±ëœ ì´ˆì•ˆ</label>
                        <textarea id="final_draft_area" style="width: 100%; height: 300px; border: 1px solid #e2e8f0; border-radius: 15px; padding: 18px; font-family: inherit; line-height: 1.6; box-sizing: border-box;">${data.content}</textarea>
                    </div>
                `;
            } else {
                fetchNewFormFields(policyId, docName);
            }
        })
        .catch(() => fetchNewFormFields(policyId, docName)); 
});
    function fetchNewFormFields(policyId, docName) {
    const container = document.getElementById('dynamicFields');
    
    container.innerHTML = `
        <div id="loadingContainer" style="text-align: center; padding: 50px 0;">
            <div class="spinner" style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #8e8ffa; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div>
            <p style="color: #718096; font-size: 14px;">AIê°€ ì„œë¥˜ì— ë§ëŠ” ì§ˆë¬¸ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
        <style> @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } </style>
    `;

    const cacheBuster = new Date().getTime();
    const apiUrl = `/api/get_form_fields/?id=${policyId}&doc=${encodeURIComponent(docName)}&v=${cacheBuster}`;
    
    fetch(apiUrl)
        .then(res => res.ok ? res.json() : Promise.reject("API Error"))
        .then(data => {
            container.innerHTML = ''; 
            if (!data.fields || data.fields.length === 0) throw "No Fields";

            data.fields.forEach(field => {
                    const questionsHtml = (field.questions || ["ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."]).map((q) => `
                    <div style="margin-bottom: 15px;">
                        <p style="font-size: 14px; color: #4a5568; margin-bottom: 8px; font-weight: 600;">Q. ${q}</p>
                        <input type="text" class="${field.id}-answer" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; padding: 14px; border: 1px solid #edf2f7; border-radius: 12px; font-size: 14px; box-sizing: border-box;">
                    </div>
                `).join('');

                container.insertAdjacentHTML('beforeend', `
                    <div class="field-group" style="background: white; border-radius: 24px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
                        <label style="font-weight: bold; font-size: 18px; color: #2d3748; display: block; margin-bottom: 15px;">${field.label}</label>
                        <div style="background: #f8fafc; padding: 20px; border-radius: 15px; margin-bottom: 15px;">
                            ${questionsHtml}
                            <button type="button" onclick="generateDraft(event, '${field.id}', '${field.label}')" style="background: #8e8ffa; color: white; border: none; padding: 15px; border-radius: 12px; cursor: pointer; width: 100%; font-weight: 600;">ğŸª„ ë‹µë³€ì„ ë¬¸ì¥ìœ¼ë¡œ ë§Œë“¤ê¸°</button>
                        </div>
                        <textarea id="${field.id}" style="width: 100%; height: 180px; border: 1px solid #e2e8f0; border-radius: 15px; padding: 18px; font-family: inherit; line-height: 1.6; display: none; box-sizing: border-box;"></textarea>
                    </div>
                `);
            });
        })
        .catch(err => {
            container.innerHTML = "<p style='text-align:center; color:#718096; padding:40px;'>í•­ëª©ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>";
        });
}

    function generateDraft(event, fieldId, label) {
        const answers = Array.from(document.querySelectorAll(`.${fieldId}-answer`)).map(i => i.value).filter(v => v.trim() !== "");
        if (answers.length === 0) return alert("ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        const btn = event.target;
        btn.innerText = "â³ ìƒì„± ì¤‘...";
        btn.disabled = true;

        fetch('/api/ai_generate_motivation/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                policy_id: new URLSearchParams(window.location.search).get('id'),
                doc_name: new URLSearchParams(window.location.search).get('doc'),
                section_name: label,
                answers: answers 
            })
        })
        .then(res => res.json())
        .then(data => {
            const textarea = document.getElementById(fieldId);
            if (data.status === "success") {
                textarea.style.display = 'block';
                textarea.value = data.result;
            } else {
                alert("AI ë‹µë³€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + data.message);
            }
        })
        .catch(err => alert("í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."))
        .finally(() => { btn.innerText = "ğŸª„ ë‹µë³€ì„ ë¬¸ì¥ìœ¼ë¡œ ë§Œë“¤ê¸°"; btn.disabled = false; });
    }

    function submitApplication() {
    const urlParams = new URLSearchParams(window.location.search);
    let finalContent = "";
    
    const savedArea = document.getElementById('final_draft_area');
    const aiTextareas = document.querySelectorAll('textarea');

    if (savedArea) {
        finalContent = savedArea.value;
    } else {
        aiTextareas.forEach(t => {
            if(t.value.trim()) finalContent += t.value + "\n\n";
        });
    }

    if (!finalContent.trim()) return alert("ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € AI ë‹µë³€ì„ ìƒì„±í•˜ê±°ë‚˜ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    
        fetch('/api/user_document_save/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                policy_id: urlParams.get('id'),
                doc_name: urlParams.get('doc'),
                content: finalContent
            })
        }).then(res => res.json()).then(data => {
            if (data.status === "success") { alert("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!"); window.history.back(); }
        }).catch(err => alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."));
    }
    </script>
</body>
</html>