<div class="container" style="padding: 20px; background: white; min-height: 100vh; font-family: 'Pretendard', sans-serif;">
  <h2 style="font-size: 22px; font-weight: bold; margin-bottom: 24px; color: #1a202c;">ğŸ“ ì‹ ì²­ì„œ ì‘ì„±</h2>

  <div id="dynamicFields">
    <div style="text-align: center; padding: 60px 0;">
      <p style="color: #a0aec0; font-size: 15px; margin-bottom: 8px;">ì„œë¥˜ í•­ëª©ê³¼ ë§ì¶¤í˜• ì§ˆë¬¸ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
      <div style="display: inline-block; width: 24px; height: 24px; border: 3px solid #edf2f7; border-top-color: #8e8ffa; border-radius: 50%; animation: spin 1s linear infinite;"></div>
    </div>
  </div>

  <button style="width: 100%; background: #a8e6cf; color: white; border: none; padding: 18px; border-radius: 20px; font-weight: bold; font-size: 16px; margin-top: 30px; cursor: pointer;">
    ì‘ì„± ì™„ë£Œ
  </button>
</div>

<style>
@keyframes spin { to { transform: rotate(360deg); } }
input[type="text"] { box-sizing: border-box !important; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const docName = urlParams.get('doc');
    // URLì—ì„œ ì •ì±… ì´ë¦„ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì •)
    const policyName = urlParams.get('policy_name') || "ì›ì£¼ì‹œ ì²­ë…„ë† ìŠ¤ë§ˆíŠ¸íŒœ êµìœ¡"; 
    const container = document.getElementById('dynamicFields');

    if (!docName || !container) return;

    // API í˜¸ì¶œ ì‹œ ì •ì±… ì´ë¦„(policy_name)ì„ í•¨ê»˜ ë³´ëƒ…ë‹ˆë‹¤.
    fetch(`/api/get_form_fields/?doc=${encodeURIComponent(docName)}&policy_name=${encodeURIComponent(policyName)}`)
        .then(res => res.json())
        .then(data => {
            container.innerHTML = ''; 

            if (!data.fields || data.fields.length === 0) {
                container.innerHTML = "<p style='text-align:center; color:#718096;'>í•­ëª©ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>";
                return;
            }

            data.fields.forEach(field => {
                const questionsHtml = (field.questions || ["ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."]).map((q, idx) => `
                    <div style="margin-bottom: 20px; text-align: left;">
                        <p style="font-size: 14px; color: #4a5568; margin-bottom: 8px; font-weight: 600;">Q. ${q}</p>
                        <input type="text" 
                               class="${field.id}-answer" 
                               placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”" 
                               style="width: 100%; min-height: 45px; padding: 12px; border: 1px solid #edf2f7; border-radius: 12px; font-size: 14px; outline: none; display: block; background: #ffffff;">
                    </div>
                `).join('');

                const sectionHtml = `
                    <div class="field-group" style="margin-bottom: 35px; border-bottom: 2px solid #f7fafc; padding-bottom: 25px;">
                        <label style="font-weight: bold; font-size: 18px; color: #2d3748; display: block; margin-bottom: 15px; text-align: left;">${field.label}</label>
                        <div style="background: #f8fafc; padding: 20px; border-radius: 15px; margin-bottom: 15px;">
                            ${questionsHtml}
                            <button type="button" onclick="generateDraft('${field.id}', '${field.label}')" 
                                    style="margin-top: 10px; background: #8e8ffa; color: white; border: none; padding: 14px; border-radius: 12px; cursor: pointer; width: 100%; font-weight: 600;">
                                ğŸª„ ë‹µë³€ì„ ë¬¸ì¥ìœ¼ë¡œ ë§Œë“¤ê¸°
                            </button>
                        </div>
                        <textarea id="${field.id}" placeholder="AIê°€ ì‘ì„±í•œ ì´ˆì•ˆì´ ì—¬ê¸°ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤. ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ìš”." 
                                  style="width: 100%; height: 160px; border: 1px solid #e2e8f0; border-radius: 15px; padding: 15px; font-family: inherit; line-height: 1.6; display: none; outline: none; box-sizing: border-box;"></textarea>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', sectionHtml);
            });
        })
        .catch(err => {
            console.error("ì˜¤ë¥˜ ë°œìƒ:", err);
            container.innerHTML = "<p style='text-align:center; color:#e53e3e;'>ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>";
        });
});

function generateDraft(fieldId, label) {
    // ëª¨ë“  ë‹µë³€ ì…ë ¥ì°½ì˜ ê°’ì„ ë°°ì—´ë¡œ ìˆ˜ì§‘í•©ë‹ˆë‹¤.
    const answers = Array.from(document.querySelectorAll(`.${fieldId}-answer`))
                         .map(input => input.value)
                         .filter(val => val.trim() !== "");

    if (answers.length === 0) {
        alert("ìµœì†Œ í•˜ë‚˜ ì´ìƒì˜ ì§ˆë¬¸ì— ë‹µë³€ì„ ì ì–´ì£¼ì„¸ìš”!");
        return;
    }

    const btn = event.target;
    const originalText = btn.innerText;
    btn.innerText = "â³ AIê°€ ë¬¸ì¥ì„ ë‹¤ë“¬ëŠ” ì¤‘...";
    btn.disabled = true;

    const urlParams = new URLSearchParams(window.location.search);
    const policyName = urlParams.get('policy_name') || "ì›ì£¼ì‹œ ì²­ë…„ë† ìŠ¤ë§ˆíŠ¸íŒœ êµìœ¡";

    // ë°±ì—”ë“œë¡œ answers ë°°ì—´ì„ ì „ì†¡í•©ë‹ˆë‹¤.
    fetch('/api/ai_generate_motivation/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            policy_name: policyName,
            doc_name: urlParams.get('doc'),
            section_name: label,
            answers: answers // ê°œë³„ ë‹µë³€ë“¤ì„ ë¦¬ìŠ¤íŠ¸ë¡œ ë³´ëƒ„
        })
    })
    .then(res => res.json())
    .then(data => {
        const textarea = document.getElementById(fieldId);
        if (data.status === "success") {
            textarea.style.display = 'block';
            textarea.value = data.result;
            // ê²°ê³¼ì°½ìœ¼ë¡œ ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤
            textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
            alert("ë¬¸ì¥ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + data.message);
        }
    })
    .catch(err => alert("í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."))
    .finally(() => {
        btn.innerText = originalText;
        btn.disabled = false;
    });
}
</script>