{% load static %}
<!doctype html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì •ì±… ê²€ìƒ‰ - ì •ì±… ì¶”ì²œ ì„œë¹„ìŠ¤</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-top" style="margin-bottom: 16px">
                <button class="btn-icon" onclick="goBack()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                </button>
                <h2 style="margin: 0">ì •ì±… ê²€ìƒ‰</h2>
                <div style="width: 44px"></div>
            </div>
        </div>

        <div class="search-bar">
            <div class="search-input-wrapper">
                <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="text" id="searchInput" class="search-input" placeholder="ì •ì±…ëª…, í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•˜ì„¸ìš”"
                    oninput="handleSearch()" />
                <button class="filter-btn" onclick="toggleFilters()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                    </svg>
                </button>
            </div>
        </div>

        <!-- í•„í„° -->
        <div id="filterPanel" class="hidden" style="padding: 0 20px 16px">
            <div style="
            background: white;
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
          ">
                <div style="
              display: flex;
              align-items: center;
              justify-content: space-between;
              margin-bottom: 20px;
            ">
                    <h3 style="margin: 0; font-size: 16px">í•„í„°</h3>
                    <button onclick="resetFilters()" style="
                background: none;
                border: none;
                color: #7ec4cf;
                font-size: 14px;
                font-family: &quot;Jua&quot;, sans-serif;
              ">
                        ì´ˆê¸°í™”
                    </button>
                </div>

                <!-- ëª¨ì§‘ì¤‘ë§Œ ë³´ê¸° -->
                <div class="form-group" style="margin-bottom: 16px">
                    <label
                        style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 14px; color: #4a5568;">
                        <input type="checkbox" id="openOnly"
                            style="width: 18px; height: 18px; accent-color: #7ec4cf; cursor: pointer;">
                        ëª¨ì§‘ì¤‘ì¸ ì •ì±…ë§Œ ë³´ê¸°
                    </label>
                </div>

                <div class="form-group">
                    <label class="form-label">ì •ì±… ë¶„ì•¼</label>
                    <select id="categoryFilter" class="form-select" onchange="updateSubCategory()">
                        <option value="all">ì „ì²´</option>
                        <option value="ì¼ìë¦¬">ì¼ìë¦¬</option>
                        <option value="êµìœ¡">êµìœ¡</option>
                    </select>
                </div>

                <div class="form-group" id="subCategoryGroup" style="display: none;">
                    <label class="form-label">ì„œë¸Œ ì¹´í…Œê³ ë¦¬</label>
                    <select id="subCategoryFilter" class="form-select">
                        <option value="all">ì „ì²´</option>
                        <!-- ë™ì ìœ¼ë¡œ ì˜µì…˜ì´ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </select>
                </div>

                <script>
                    // API ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’(fallback)
                    window.SUB_CATEGORY_MAP = {
                        "ì¼ìë¦¬": ["ì°½ì—…", "ì·¨ì—…", "ì¬ì§ì"],
                        "êµìœ¡": ["ë¯¸ë˜ì—­ëŸ‰ê°•í™”", "ì˜¨ë¼ì¸êµìœ¡", "êµìœ¡ë¹„ì§€ì›"]
                    };
                    window.REGION_OPTIONS = [
                        "ì„œìš¸", "ê²½ê¸°", "ì¸ì²œ", "ê°•ì›", "ì¶©ë¶", "ì¶©ë‚¨", "ëŒ€ì „", "ê´‘ì£¼",
                        "ì „ë¶", "ì „ë‚¨", "ëŒ€êµ¬", "ê²½ë¶", "ê²½ë‚¨", "ë¶€ì‚°", "ìš¸ì‚°", "ì œì£¼", "ì„¸ì¢…"
                    ];
                    window.JOB_STATUS_OPTIONS = [
                        "ë¯¸ì·¨ì—…ì", "(ì˜ˆë¹„)ì°½ì—…ì", "ì¬ì§ì", "ê¸°íƒ€", "ì˜ë†ì¢…ì‚¬ì"
                    ];

                    function updateSubCategory() {
                        const category = document.getElementById("categoryFilter").value;
                        const subGroup = document.getElementById("subCategoryGroup");
                        const subSelect = document.getElementById("subCategoryFilter");

                        subSelect.innerHTML = '<option value="all">ì „ì²´</option>';

                        const options = window.SUB_CATEGORY_MAP[category] || [];
                        if (category !== "all" && options.length > 0) {
                            subGroup.style.display = "block";
                            options.forEach(opt => {
                                subSelect.innerHTML += `<option value="${opt}">${opt}</option>`;
                            });
                        } else {
                            subGroup.style.display = "none";
                            subSelect.value = "all";
                        }
                    }
                </script>

                <div class="form-group">
                    <label class="form-label">ë‚˜ì´ (ë§Œ ë‚˜ì´)</label>
                    <input type="number" id="ageFilter" class="form-input" placeholder="ì˜ˆ: 25" min="15" max="49"
                        style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 14px; box-sizing: border-box;">
                </div>

                <div class="form-group">
                    <label class="form-label">ì§€ì—­</label>
                    <select id="regionFilter" class="form-select">
                        <option value="all">ì „ì²´</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 20px">
                    <label class="form-label">ì§ì—… ìƒíƒœ</label>
                    <select id="jobStatusFilter" class="form-select">
                        <option value="all">ì „ì²´</option>
                    </select>
                </div>

                <button onclick="applyFilters()"
                    style="width: 100%; background: #7ec4cf; color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer;">í•„í„°
                    ì ìš©</button>
            </div>
        </div>

        <!-- ê²€ìƒ‰ ê²°ê³¼ -->

        <div style="padding: 0 20px 24px">
            <p id="resultCount" style="color: #7a8a9e; font-size: 14px; margin-bottom: 16px">
                ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
            </p>
            <div id="searchResults" style="display: flex; flex-direction: column; gap: 16px"></div>
            <div id="pagination"></div>

            <div id="noResults" class="hidden" style="text-align: center; padding: 60px 20px">
                <div style="font-size: 48px; margin-bottom: 16px">ğŸ”</div>
                <h3 style="color: #2d3748; margin-bottom: 8px">
                    ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤
                </h3>
                <p style="color: #a0aec0; font-size: 14px">
                    ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”
                </p>
            </div>
        </div>
    </div>

    <!-- í™ˆ ì´ë™ ë²„íŠ¼ -->
    <button id="floatingHome" class="floating-home" onclick="window.location.href = '/'">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2">
            <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
    </button>

    <script src="{% static 'js/data.js' %}"></script>
    <script src="{% static 'js/main.js' %}"></script>
    <script src="{% static 'search/js/api_search.js' %}"></script>
    <script>
        // ============================================================================
        // ê²€ìƒ‰ í™”ë©´ ë™ì‘ ìŠ¤í¬ë¦½íŠ¸
        // ============================================================================
        let debounceTimer;

        /**
         * ê²€ìƒ‰ ì…ë ¥ ì‹œ ë””ë°”ìš´ìŠ¤ë¡œ API í˜¸ì¶œ ë¹ˆë„ë¥¼ ì¤„ì…ë‹ˆë‹¤.
         */
        function handleSearch() {
            const query = document.getElementById("searchInput").value; // í–¥í›„ í™•ì¥ ëŒ€ë¹„ ë³€ìˆ˜ ìœ ì§€

            // ì…ë ¥ í›„ 300ms ëŒ€ê¸°í–ˆë‹¤ê°€ ê²€ìƒ‰ ì‹¤í–‰
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                // ê²€ìƒ‰ì–´/í•„í„° ë³€ê²½ ì‹œ í•­ìƒ 1í˜ì´ì§€ë¶€í„° ì¬ì¡°íšŒ
                performSearch(1);
            }, 300);
        }

        /**
         * í•„í„°ë¥¼ ì ìš©í•˜ê³  íŒ¨ë„ì„ ë‹«ìŠµë‹ˆë‹¤.
         */
        function applyFilters() {
            performSearch(1);
            toggleFilters();
        }

        /**
         * í•„í„° íŒ¨ë„ ì—´ê¸°/ë‹«ê¸°
         */
        function toggleFilters() {
            const panel = document.getElementById("filterPanel");
            panel.classList.toggle("hidden");
        }

        /**
         * í•„í„°ì™€ ê²€ìƒ‰ì–´ë¥¼ ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë¦¬ê³  ëª©ë¡ì„ ë‹¤ì‹œ ì¡°íšŒí•©ë‹ˆë‹¤.
         */
        function resetFilters() {
            document.getElementById("categoryFilter").value = "all";
            updateSubCategory(); // ì„œë¸Œ ì¹´í…Œê³ ë¦¬ ê·¸ë£¹ ìˆ¨ê¹€ ì²˜ë¦¬ ë° ì´ˆê¸°í™”
            document.getElementById("ageFilter").value = "";
            document.getElementById("regionFilter").value = "all";
            document.getElementById("jobStatusFilter").value = "all";
            const openOnly = document.getElementById("openOnly");
            if (openOnly) openOnly.checked = false;
            document.getElementById("searchInput").value = "";
            document.getElementById("searchResults").innerHTML = "";
            document.getElementById("resultCount").textContent = "";
            document.getElementById("noResults").classList.add("hidden");
            document.getElementById("pagination").innerHTML = "";
            performSearch(1);
        }

        // ê²€ìƒ‰ì°½ ì—”í„°í‚¤ ì…ë ¥ ì‹œ ì¦‰ì‹œ ê²€ìƒ‰
        document.getElementById("searchInput").addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                performSearch(1);
            }
        });

        function populateSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) return;

            const previous = select.value;
            select.innerHTML = '<option value="all">ì „ì²´</option>';

            (options || []).forEach(opt => {
                select.innerHTML += `<option value="${opt}">${opt}</option>`;
            });

            if (previous && previous !== "all" && (options || []).includes(previous)) {
                select.value = previous;
            } else {
                select.value = "all";
            }
        }

        async function loadFilterOptions() {
            populateSelectOptions("regionFilter", window.REGION_OPTIONS);
            populateSelectOptions("jobStatusFilter", window.JOB_STATUS_OPTIONS);

            try {
                const response = await fetch("/search/api/filter-options");
                if (!response.ok) return;
                const data = await response.json();

                if (data && data.sub_categories) {
                    window.SUB_CATEGORY_MAP = data.sub_categories;
                }
                if (data && Array.isArray(data.regions) && data.regions.length > 0) {
                    window.REGION_OPTIONS = data.regions;
                }
                if (data && Array.isArray(data.job_statuses) && data.job_statuses.length > 0) {
                    window.JOB_STATUS_OPTIONS = data.job_statuses;
                }

                populateSelectOptions("regionFilter", window.REGION_OPTIONS);
                populateSelectOptions("jobStatusFilter", window.JOB_STATUS_OPTIONS);
            } catch (error) {
                console.warn("í•„í„° ì˜µì…˜ ë¡œë“œ ì‹¤íŒ¨:", error);
            } finally {
                updateSubCategory();
            }
        }

        // í˜ì´ì§€ ì§„ì… ì‹œ í•„í„° ì˜µì…˜ ë¡œë“œ í›„ ì „ì²´ ëª©ë¡ ì¡°íšŒ
        loadFilterOptions().finally(() => {
            performSearch(1);
        });
    </script>
</body>

</html>
