{% load static %}

<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì„¤ë¬¸ ê²°ê³¼ - ì •ì±… ì¶”ì²œ ì„œë¹„ìŠ¤</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="header-top">
          <button
            class="btn-icon"
            onclick="location.href='/'"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="19" y1="12" x2="5" y2="12"></line>
              <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
          </button>
          <h2 style="margin: 0">ë§ì¶¤ ì¶”ì²œ ê²°ê³¼</h2>
          <div style="width: 44px"></div>
        </div>
      </div>

      <div class="survey-container">
        <!-- Celebration -->
        <div style="text-align: center; margin-bottom: 32px">
          <div style="font-size: 64px; margin-bottom: 16px">ğŸ‰</div>
          <h1 style="margin-bottom: 8px">ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆì–´ìš”!</h1>
          <p style="color: #7a8a9e; font-size: 14px">
            ë‹¹ì‹ ì—ê²Œ ë”± ë§ëŠ” ì •ì±…ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤
          </p>
        </div>

        <!-- Results Summary -->
        <div
          style="
            background: linear-gradient(to right, #a8e6cf, #7ec4cf);
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
          "
        >
          <p
            style="
              color: white;
              font-size: 14px;
              margin-bottom: 8px;
              opacity: 0.9;
            "
          >
            ì´ ë§¤ì¹­ ì •ì±…
          </p>
          <p
            style="color: white; font-size: 48px; font-weight: bold; margin: 0"
            id="matchCount"
          >
            ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
          </p>
        </div>

        <!-- Survey Answers -->
        <div
          style="
            background: white;
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 24px;
          "
        >
          <h3 style="font-size: 16px; color: #2d3748; margin-bottom: 16px">
            ğŸ“‹ ë‚˜ì˜ ì •ë³´
          </h3>
          <div id="surveyAnswers"></div>
        </div>

        <!-- Recommended Policies -->
        <div style="margin-bottom: 24px">
          <h3 style="font-size: 16px; color: #2d3748; margin-bottom: 16px">
            âœ¨ ì¶”ì²œ ì •ì±…
          </h3>
          <div
            id="recommendedPolicies"
            style="display: flex; flex-direction: column; gap: 16px"
          ></div>
          <!-- âœ… ë”ë³´ê¸° ë²„íŠ¼ -->
          <div style="text-align:center; margin-top: 12px;">
            <button id="btnLoadMore" class="btn-secondary" style="display:none;">
              ë”ë³´ê¸°
            </button>
          </div>
        </div>

        <div style="display: flex; gap: 12px">
          <button
            class="btn-secondary"
            onclick="window.location.href = 'survey.html'"
          >
            ë‹¤ì‹œ ì„¤ë¬¸í•˜ê¸°
          </button>
          <button
            class="btn-primary"
            onclick="location.href='/'"
          >
            í™ˆìœ¼ë¡œ
          </button>
        </div>
      </div>
    </div>

    <!-- Floating Home Button -->
    <button
      id="floatingHome"
      class="floating-home"
      onclick="location.href='/'"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        <polyline points="9 22 9 12 15 12 15 22"></polyline>
      </svg>
    </button>

    <script src="{% static 'js/data.js' %}"></script>
    <script src="{% static 'js/main.js' %}"></script>
    <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const answers = survey.getAnswers();

      if (Object.keys(answers).length === 0) {
        window.location.href = "survey.html";
        return;
      }

      // ì„¤ë¬¸ ë‹µë³€ í‘œì‹œ
      const answersContainer = document.getElementById("surveyAnswers");
      answersContainer.innerHTML = SURVEY_QUESTIONS.map(
        (q, index) => `
          <div style="margin-bottom: 16px; padding-bottom: 16px; ${
            index < SURVEY_QUESTIONS.length - 1 ? "border-bottom: 1px solid #f0f4f8;" : ""
          }">
            <p style="font-size: 12px; color: #a0aec0; margin-bottom: 4px;">${q.question}</p>
            <p style="font-size: 14px; color: #2d3748; margin: 0;">${answers[index + 1] || "-"}</p>
          </div>
        `
      ).join("");

      // -------------------------
      // âœ… ì¶”ì²œ ì •ì±…: ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ê¸°
      // -------------------------
      function calcDday(endDateStr) {
        if (!endDateStr) return "D-?";
        const end = new Date(endDateStr);
        const now = new Date();
        const diff = Math.ceil((end - now) / (1000 * 60 * 60 * 24));
        if (diff < 0) return "ë§ˆê°";
        return `D-${diff}`;
      }

      function toMatchPercent(score) {
        const v = Math.max(0, Math.min(1, Number(score) || 0));
        return Math.round(v * 100);
      }

      // âœ… ì„œë²„ëŠ” topkë¥¼ ë¬´ì‹œí•˜ëŠ” ìƒíƒœë¼ ê°€ì •: "í•œ ë²ˆë§Œ" ë°›ì•„ì„œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ í˜ì´ì§•
      async function loadRecommendationsOnce() {
        const res = await fetch(`/survey/api/recommend/`); // topk ì œê±° (ë¬´ì‹œë˜ëŠ” ìƒíƒœë¼ ì˜ë¯¸ ì—†ìŒ)
        const data = await res.json();

        console.log("ğŸ“¦ recommend API response:", data);

        if (!res.ok || !data.ok) {
          console.error("recommend api error:", data);
          return [];
        }

        const items = data.items || [];

        // âœ… ì•ˆì „ì¥ì¹˜: policy_id ê¸°ì¤€ ì¤‘ë³µ ì œê±°
        const uniq = [];
        const seen = new Set();
        for (const it of items) {
          const key = it.policy_id ?? JSON.stringify(it);
          if (!seen.has(key)) {
            seen.add(key);
            uniq.push(it);
          }
        }
        return uniq;
      }

      const policiesContainer = document.getElementById("recommendedPolicies");
      const btnLoadMore = document.getElementById("btnLoadMore");
      const matchCountEl = document.getElementById("matchCount");

      const PAGE_SIZE = 5;
      let shown = PAGE_SIZE;     // í˜„ì¬ í™”ë©´ì— ë³´ì—¬ì¤„ ê°œìˆ˜
      let allItems = [];         // ì„œë²„ì—ì„œ ë°›ì€ ì „ì²´ ì¶”ì²œ ëª©ë¡

      function renderPolicies(itemsToShow) {
        policiesContainer.innerHTML = itemsToShow
          .map((p) => {
            const dday = calcDday(p.apply_end_date);
            const match = toMatchPercent(p.score);
            const detailUrl = `/policy/detail/?id=${encodeURIComponent(p.policy_id)}`;

            return `
              <a href="${detailUrl}" style="text-decoration:none; color:inherit; display:block;">
                <div style="background: white; border-radius: 24px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.3s;"
                    onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.1)'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">

                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                    <span style="padding: 4px 12px; background: linear-gradient(to right, #a8e6cf, #7ec4cf); color: white; border-radius: 50px; font-size: 12px;">
                      ${p.category || "ê¸°íƒ€"}
                    </span>
                    <span style="padding: 4px 12px; background: #ff7eb9; color: white; border-radius: 50px; font-size: 12px;">
                      ${dday}
                    </span>
                  </div>

                  <h4 style="font-size: 16px; color: #2d3748; margin-bottom: 8px;">
                    ${p.name || "(ì œëª©ì—†ìŒ)"}
                  </h4>

                  <div style="font-size: 12px; color: #7a8a9e; margin-bottom: 12px;">
                    ğŸ—ºï¸ ${p.region || "ì „êµ­"} ${p.agency ? ` Â· ğŸ›ï¸ ${p.agency}` : ""}
                  </div>

                  <div style="background: linear-gradient(to bottom right, #f8f9fd, #e8f4f8); border-radius: 16px; padding: 12px; margin-bottom: 12px; font-size: 13px; color: #7a8a9e;">
                    ğŸ’¬ ${p.reason_snippet ? p.reason_snippet : "ë‚´ ìƒí™©ê³¼ ìœ ì‚¬í•œ ì¡°ê±´ì˜ ì •ì±…ì´ì—ìš”!"}
                  </div>

                  <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span style="font-size: 12px; color: #a0aec0;">ë§¤ì¹­ë¥ </span>
                    <span style="font-size: 16px; color: #7ec4cf; font-weight: bold;">${match}%</span>
                  </div>
                </div>
              </a>
            `;
          })
          .join("");
      }

      function updateUI() {
        // âœ… ì´ ë§¤ì¹­ ê°œìˆ˜ëŠ” í•­ìƒ "ì „ì²´" ê¸°ì¤€
        matchCountEl.textContent = `${allItems.length}ê°œ`;

        const itemsToShow = allItems.slice(0, shown);
        renderPolicies(itemsToShow);

        // âœ… ë”ë³´ê¸° ë²„íŠ¼: ì•„ì§ ë‚¨ì•„ìˆìœ¼ë©´ ë…¸ì¶œ
        if (shown >= allItems.length) {
          btnLoadMore.style.display = "none";
        } else {
          btnLoadMore.style.display = "inline-block";
        }
      }

      // âœ… ì´ˆê¸° ë¡œë”©
      policiesContainer.innerHTML = `<div style="color:#7a8a9e; font-size:14px;">ì¶”ì²œ ì •ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>`;
      btnLoadMore.style.display = "none";

      allItems = await loadRecommendationsOnce();

      if (allItems.length === 0) {
        policiesContainer.innerHTML = `
          <div style="color:#7a8a9e; font-size:14px;">
            ì¶”ì²œ ì •ì±…ì´ ì—†ì–´ìš”. ì„¤ë¬¸ì„ ë‹¤ì‹œ í•´ë³´ê±°ë‚˜ ì¡°ê±´ì„ ë°”ê¿”ë³´ì„¸ìš”.
          </div>
        `;
        matchCountEl.textContent = `0ê°œ`;
        return;
      }

      // ì²˜ìŒì—” 5ê°œë§Œ ë³´ì—¬ì£¼ê¸°
      shown = Math.min(PAGE_SIZE, allItems.length);
      updateUI();

      // âœ… ë”ë³´ê¸°: 5ê°œì”© ì¶”ê°€
      btnLoadMore.addEventListener("click", () => {
        shown = Math.min(shown + PAGE_SIZE, allItems.length);
        updateUI();
      });
    });
  </script>
  </body>
</html>
