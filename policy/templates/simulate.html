{% load static %}
<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìê²© ì§„ë‹¨ - {{ policy.policy_name }}</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body style="background-color: #f8f9fa; font-family: 'Pretendard', sans-serif;">
    <div class="container" style="max-width: 480px; margin: 0 auto; background: #f8f9fa; min-height: 100vh; padding-bottom: 100px;">
        <div style="padding: 20px; background: white; display: flex; align-items: center; gap: 15px; position: sticky; top: 0; z-index: 100;">
            <button onclick="history.back()" style="border:none; background:none; cursor:pointer; padding: 0;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2d3748" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <h2 style="margin:0; font-size:18px; color: #2d3748; font-weight: 700;">ì •ì±… ìƒì„¸</h2>
        </div>

        <div style="padding: 20px;">
            <div style="background: linear-gradient(135deg, #a8e6cf 0%, #dcedc1 100%); color: #2d3748; padding: 28px 24px; border-radius: 24px; margin-bottom: 24px; box-shadow: 0 10px 20px rgba(168, 230, 207, 0.2);">
                <span style="background: rgba(255,255,255,0.6); padding: 4px 12px; border-radius: 50px; font-size: 12px; font-weight: bold; color: #4b7f6e;">{{ policy.category|default:"ë¶„ë¥˜" }}</span>
                <h3 style="margin:12px 0 0 0; font-size:22px; font-weight: 800; line-height: 1.4; color: #2d4a41;">ì‹ ì²­ ìê²© ìš”ê±´ì„<br>í™•ì¸í•´ë³¼ê¹Œìš”?</h3>
            </div>

            <div id="qa-list">
                <p style="text-align:center; color:#a0aec0; padding: 40px 0;">ì¡°ê±´ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
            </div>

            <button id="show-result" disabled onclick="calculateResult()" 
                style="width: 100%; padding: 20px; border-radius: 20px; border:none; background: #cbd5e0; color:white; font-weight:bold; font-size:17px; cursor:pointer; margin-top: 20px; transition: all 0.3s ease;">
                ê²°ê³¼ í™•ì¸í•˜ê¸°
            </button>
        </div>
    </div>

    <div id="result-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center; padding:20px; backdrop-filter: blur(8px);">
        <div style="background:white; width:100%; max-width:400px; border-radius:32px; padding:32px; text-align:center;">
            <div id="result-icon" style="font-size: 64px; margin-bottom: 20px;"></div>
            <h3 id="result-title" style="font-size: 24px; margin-bottom: 12px; color: #2d3748; font-weight: 800;"></h3>
            <p id="result-desc" style="color:#718096; font-size:15px; line-height:1.6; margin-bottom: 30px;"></p>
            <button onclick="location.href='/policy/apply/?id={{ policy_id }}'" id="apply-btn" style="width:100%; padding:18px; border-radius:16px; border:none; background:#6abda6; color:white; font-weight:bold; margin-bottom:12px; font-size: 16px;">ì„œë¥˜ ì¤€ë¹„í•˜ëŸ¬ ê°€ê¸°</button>
            <button onclick="document.getElementById('result-modal').style.display='none'" style="width:100%; padding:18px; border-radius:16px; border:1px solid #edf2f7; background:white; color:#a0aec0; font-weight: 600;">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
    const policyId = "{{ policy_id }}";
    
    let userInfo = {};
    const userInfoRaw = '{{ user_info|safe|default:"{}" }}';
    try {
        userInfo = JSON.parse(userInfoRaw.replace(/'/g, '"'));
    } catch(e) {
        console.warn("User info parsing failed or empty");
    }
    
    let questionsData = [];
    let userChoices = {};

    document.addEventListener('DOMContentLoaded', function() {
        fetch(`/api/get_policy_requirements/?id=${policyId}`)
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    questionsData = data.questions || data.items || [];
                    renderQuestions();
                }
            })
            .catch(err => {
                document.getElementById('qa-list').innerHTML = `<p style="text-align:center; color:#e53e3e;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
            });
    });

    function renderQuestions() {
        const container = document.getElementById('qa-list');
        container.innerHTML = questionsData.map((q, i) => {
            const currentChoice = userChoices[i];
            const qText = q.question || q.text || "ì¡°ê±´ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";

            return `
            <div style="background:white; padding:24px; border-radius:24px; margin-bottom:16px; box-shadow:0 8px 20px rgba(0,0,0,0.03); border: 1px solid #f1f3f5;">
                <div style="display:flex; align-items:flex-start; gap:12px; margin-bottom:20px;">
                    <div style="min-width:24px; height:24px; background:#e0f7f1; color:#4b7f6e; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:800;">${i+1}</div>
                    <p style="margin:0; font-size:16px; font-weight:700; color:#2d3748; line-height:1.5;">${qText}</p>
                </div>
                <div style="display:flex; gap:12px;">
                    <button onclick="setChoice(${i}, 'yes')" 
                        style="flex:1; padding:16px; border-radius:16px; font-weight:bold; transition:all 0.2s;
                        ${currentChoice === 'yes' 
                            ? 'background:#6abda6; color:white; border:none; box-shadow: 0 4px 12px rgba(106,189,166,0.3);' 
                            : 'background:#f8f9fa; color:#718096; border:1px solid #edf2f7;'}">
                        ì˜ˆ
                    </button>
                    <button onclick="setChoice(${i}, 'no')" 
                        style="flex:1; padding:16px; border-radius:16px; font-weight:bold; transition:all 0.2s;
                        ${currentChoice === 'no' 
                            ? 'background:#6abda6; color:white; border:none; box-shadow: 0 4px 12px rgba(106,189,166,0.3);' 
                            : 'background:#f8f9fa; color:#718096; border:1px solid #edf2f7;'}">
                        ì•„ë‹ˆì˜¤
                    </button>
                </div>
            </div>
            `;
        }).join('');
        checkAllAnswered();
    }

    function setChoice(index, choice) {
        userChoices[index] = choice;
        renderQuestions();
    }

    function checkAllAnswered() {
        const btn = document.getElementById('show-result');
        if (Object.keys(userChoices).length === questionsData.length && questionsData.length > 0) {
            btn.disabled = false;
            btn.style.background = '#4b7f6e'; 
            btn.style.boxShadow = '0 8px 20px rgba(75, 127, 110, 0.2)';
        }
    }

    function calculateResult() {
        let isEligible = true;
        questionsData.forEach((q, i) => {
            const choice = userChoices[i];
            if (q.type === 'exclusion' && choice === 'yes') isEligible = false;
            if (q.type === 'condition' && choice === 'no') isEligible = false;
        });

        const modal = document.getElementById('result-modal');
        const icon = document.getElementById('result-icon');
        const title = document.getElementById('result-title');
        const desc = document.getElementById('result-desc');

        if (isEligible) {
            icon.innerText = "ğŸ‰";
            title.innerText = "ì‹ ì²­í•˜ê¸°ì— ì í•©í•´ìš”!";
            desc.innerHTML = "ëª¨ë“  ìê²© ìš”ê±´ì„ ì¶©ì¡±í•˜ì‹œëŠ” ê²ƒ ê°™ë„¤ìš”.<br>ì¤€ë¹„ ì„œë¥˜ë¥¼ í™•ì¸í•˜ê³  ë°”ë¡œ ì‹ ì²­í•´ë³´ì„¸ìš”!";
            document.getElementById('apply-btn').style.display = "block";
            document.getElementById('apply-btn').style.background = "#6abda6";
        } else {
            icon.innerText = "ğŸ˜¥";
            title.innerText = "í™•ì¸ì´ í•„ìš”í•´ìš”";
            desc.innerHTML = "ì¼ë¶€ ì¡°ê±´ì´ ë§ì§€ ì•Šê±°ë‚˜ ì œì™¸ ëŒ€ìƒì— í•´ë‹¹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>ìƒì„¸ ê³µê³ ë¬¸ì„ ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•´ì£¼ì„¸ìš”.";
            document.getElementById('apply-btn').style.display = "none";
        }
        modal.style.display = "flex";
    }
    </script>
</body>
</html>