{% load static %}
<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>로그인 - 정책 추천 서비스</title>
    <script src="https://accounts.google.com/gsi/client" async></script>
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
    <style>
      .btn-google {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        padding: 14px 24px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        color: var(--text);
        font-family: "DM Sans", sans-serif;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.25s ease;
        position: relative;
        overflow: hidden;
      }

      .divider {
        display: flex;
        align-items: center;
        gap: 16px;
        margin: 20px 0;
        color: #7a8a9e;
      }

      .divider::before,
      .divider::after {
        content: "";
        flex: 1;
        height: 1px;
        background: var(--border);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="header-top">
          <button class="btn-icon" onclick="goBack()">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="19" y1="12" x2="5" y2="12"></line>
              <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
          </button>
          <h2 style="margin: 0">로그인</h2>
          <div style="width: 44px"></div>
        </div>
      </div>

      <div class="survey-container">
        <div style="text-align: center; margin-bottom: 20px">
          <div
            style="
              width: 100px;
              height: 100px;
              margin: 0 auto 20px;
              border-radius: 50%;
              background: linear-gradient(to bottom right, #a8e6cf, #7ec4cf);
              display: flex;
              align-items: center;
              justify-content: center;
              box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            "
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="48"
              height="48"
              viewBox="0 0 24 24"
              fill="none"
              stroke="white"
              stroke-width="2"
            >
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </div>
          <h1 style="margin-bottom: 8px">환영합니다!</h1>
          <p style="color: #7a8a9e">맞춤 정책을 추천받으세요</p>
        </div>

        {% if is_login %}
        <div style="text-align: center; margin-top: 50px">
          <h3>로그인 중입니다.</h3>
        </div>
        {% else %}
        <!-- g_id_onload contains Google Identity Services settings -->
        <div
          id="g_id_onload"
          data-auto_prompt="false"
          data-callback="onGoogleCredential"
          data-client_id="{{ GOOGLE_CLIENT_ID }}"
        ></div>
        <!-- g_id_signin places the button on a page and supports customization -->
        <div class="g_id_signin"></div>

        <div class="divider"><span>또는 이메일로 로그인</span></div>

        <form id="loginForm" onsubmit="handleLogin(event)">
          <div class="form-group">
            <label class="form-label">이메일</label>
            <input
              type="email"
              id="emailInput"
              class="form-input"
              placeholder="example@email.com"
              required
            />
          </div>
          <div class="form-group">
            <label class="form-label">비밀번호</label>
            <input
              type="password"
              id="nameInput"
              class="form-input"
              placeholder="비밀번호를 입력하세요"
              required
            />
          </div>
          <button type="submit" class="btn-primary" style="margin-top: 32px">
            시작하기
          </button>
        </form>

        <p
          style="
            text-align: center;
            margin-top: 24px;
            font-size: 14px;
            color: #a0aec0;
          "
        >
          로그인 없이도 대부분의 기능을 사용할 수 있습니다.<br />
          개인화된 추천을 위해서는 로그인이 필요합니다.
        </p>
        {% endif %}
      </div>
    </div>

    <!-- Floating Home Button -->
    <button
      id="floatingHome"
      class="floating-home"
      onclick="window.location.href = 'index.html'"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        <polyline points="9 22 9 12 15 12 15 22"></polyline>
      </svg>
    </button>

    <script>
      async function onGoogleCredential(response) {
        console.log("Encoded JWT ID token: " + response.credential);

        try {
          const res = await fetch("/accounts/api/auth/google/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id_token: response.credential }),
          });

          const data = await res.json();

          console.log("data", data);

          if (!res.ok)
            throw new Error(data.message || "로그인에 실패했습니다.");

          alert("로그인 성공! 대시보드로 이동합니다.", "success");
        } catch (err) {
          alert(err.message, "error");
        }

        const responsePayload = decodeJWT(response.credential);

        console.log("Decoded JWT ID token fields:");
        console.log("  Full Name: " + responsePayload.name);
        console.log("  Given Name: " + responsePayload.given_name);
        console.log("  Family Name: " + responsePayload.family_name);
        console.log("  Unique ID: " + responsePayload.sub);
        console.log("  Profile image URL: " + responsePayload.picture);
        console.log("  Email: " + responsePayload.email);
      }
    </script>

    <script>
      function handleLogin(event) {
        event.preventDefault();

        const name = document.getElementById("nameInput").value;
        const email = document.getElementById("emailInput").value;
        const age = document.getElementById("ageInput").value;

        // 사용자 정보 저장
        user.login(name);
        user.updateProfile({
          email: email,
          age: age,
        });

        alert(`${name}님, 환영합니다!`);
        window.location.href = "index.html";
      }
    </script>
  </body>
</html>
