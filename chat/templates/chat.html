{% load static %}

<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI ìƒë‹´ - ì •ì±… ì¶”ì²œ ì„œë¹„ìŠ¤</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
    <link rel="stylesheet" href="{% static 'css/chat.css' %}" />
    <style>
      .typing-indicator {
        display: inline-flex;
        align-items: center;
        padding: 12px 16px;
        background: #ffffff;
        border-radius: 15px;
        border-top-left-radius: 4px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        margin-bottom: 10px;
      }
      .typing-indicator span {
        height: 6px;
        width: 6px;
        background: #8fd3ce; /* ì „ì†¡ ë²„íŠ¼ê³¼ ê°™ì€ ë¯¼íŠ¸ìƒ‰ */
        border-radius: 50%;
        margin: 0 3px;
        display: block;
        animation: bounce 1.3s infinite ease-in-out;
      }
      .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
      .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
      @keyframes bounce {
        0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
        40% { transform: scale(1.2); opacity: 1; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="header-top">
          <button class="btn-icon" onclick="goBack()">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="19" y1="12" x2="5" y2="12"></line>
              <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
          </button>
          <div style="flex: 1; text-align: center">
            <h2 style="margin: 0">AI ìƒë‹´</h2>
            <p style="margin: 0; font-size: 12px; color: #a0aec0">
              24ì‹œê°„ ì–¸ì œë‚˜ ìƒë‹´ ê°€ëŠ¥
            </p>
          </div>
          <div style="width: 44px"></div>
        </div>
      </div>

      <div class="chat-container">
        <div id="chatMessages" class="chat-messages"></div>

        <div class="quick-questions" id="quickQuestions">
          <button
            class="quick-question-btn"
            onclick="sendMessage('ì²­ë…„ ì›”ì„¸ ì§€ì›ì‚¬ì—…ì— ëŒ€í•´ ì•Œë ¤ì¤˜')"
          >
            ì²­ë…„ ì›”ì„¸ ì§€ì›ì‚¬ì—…
          </button>
          <button
            class="quick-question-btn"
            onclick="sendMessage('ë‚˜ì´ 25ì„¸ì— ë°›ì„ ìˆ˜ ìˆëŠ” ì •ì±…ì€?')"
          >
            ë‚˜ì´ë³„ ì •ì±…
          </button>
          <button
            class="quick-question-btn"
            onclick="sendMessage('ì·¨ì—… ê´€ë ¨ ì •ì±… ì¶”ì²œí•´ì¤˜')"
          >
            ì·¨ì—… ì •ì±…
          </button>
          <button
            class="quick-question-btn"
            onclick="sendMessage('ì‹ ì²­ ë°©ë²•ì´ ê¶ê¸ˆí•´')"
          >
            ì‹ ì²­ ë°©ë²•
          </button>
        </div>

        <div class="chat-input-wrapper">
          <form class="chat-input-form" onsubmit="handleSubmit(event)">
            <input
              type="text"
              id="chatInput"
              class="chat-input"
              placeholder="ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”..."
              autocomplete="off"
            />
            <button type="submit" id="sendBtn" class="chat-send-btn">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="white"
                stroke-width="2"
              >
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
              </svg>
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Floating Home Button -->
    <button
      id="floatingHome"
      class="floating-home"
      onclick="window.location.href = 'index.html'"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        <polyline points="9 22 9 12 15 12 15 22"></polyline>
      </svg>
    </button>

   <script src="{% static 'js/data.js' %}"></script>
    <script src="{% static 'js/main.js' %}"></script>
    <script>
      const chatMessages = document.getElementById("chatMessages");
      const chatInput = document.getElementById("chatInput");
      const sendBtn = document.getElementById("sendBtn");
      const quickQuestions = document.getElementById("quickQuestions");

      // ë¡œë”© ìš”ì†Œë¥¼ ê´€ë¦¬í•  ì „ì—­ ë³€ìˆ˜
      let loadingElement = null;

      // í™”ë©´ ì²˜ìŒ ì—´ì—ˆì„ ë•Œ ë©”ì„¸ì§€ ë…¸ì¶œ ì²˜ë¦¬
      document.addEventListener("DOMContentLoaded", () => {
        loadChatHistory();
        chatInput.focus();
      });

      // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ìƒì„± í•¨ìˆ˜
      function showLoading() {
        const loadingDiv = document.createElement("div");
        loadingDiv.className = "chat-message ai";
        loadingDiv.innerHTML = `
          <div class="chat-avatar ai">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
              <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"></path>
            </svg>
          </div>
          <div class="typing-indicator">
            <span></span><span></span><span></span>
          </div>
        `;
        chatMessages.appendChild(loadingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return loadingDiv;
      }

      // ê³¼ê±° ëŒ€í™” ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°
      function loadChatHistory() {
        fetch(`/chat/api/chat_init`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((result) => {
            console.log("loadChatHistory", result);
            loadChatHistory_callback(result.data);
          })
          .catch((error) => {
            console.error("loadChatHistory catch :", error);
          });
      }

      // ê³¼ê±° ëŒ€í™” ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸° ì½œë°±
      function loadChatHistory_callback(data) {
        if (!data || data.length === 0) {
          const welcomeMessage =
            "ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹\nì •ì±… ì¶”ì²œ AI ìƒë‹´ì‚¬ì…ë‹ˆë‹¤.\n\nê¶ê¸ˆí•˜ì‹  ì •ì±…ì´ë‚˜ ì‹ ì²­ ë°©ë²•ì— ëŒ€í•´ ë¬¼ì–´ë³´ì„¸ìš”!";
          addAIMessage(welcomeMessage);
        }
      }

      // í™”ë©´ì— ë©”ì„¸ì§€ ë…¸ì¶œ
      function addMessage(text, isUser) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `chat-message ${isUser ? "user" : "ai"}`;

        messageDiv.innerHTML = `
        <div class="chat-avatar ${isUser ? "user" : "ai"}">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            ${
              isUser
                ? '<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle>'
                : '<path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"></path>'
            }
          </svg>
        </div>
        <div class="chat-bubble ${isUser ? "user" : "ai"}">${text.replace(/\n/g, "<br>")}</div>
      `;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function addAIMessage(text) {
        addMessage(text, false);
      }

      function addUserMessage(text) {
        addMessage(text, true);
      }

      // ì‚¬ìš©ìê°€ ë©”ì„¸ì§€ ì „ì†¡ (ì¤‘ë³µ ì œê±° ë²„ì „)
      function handleSubmit(event) {
        event.preventDefault();

        const text = chatInput.value.trim();
        if (!text) return;

        quickQuestions.style.display = "none";
        chatInput.value = "";
        addUserMessage(text);

        sendBtn.disabled = true;
        chatInput.disabled = true;

        // --- 1. ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ ---
        loadingElement = showLoading();

        fetch(`/chat/api/chat_response`, {
          method: "POST",
          body: JSON.stringify({ message: text }),
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((result) => {
            // --- 2. ì‘ë‹µ ì‹œ ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì œê±° ---
            if (loadingElement) {
              loadingElement.remove();
              loadingElement = null;
            }
            chat_response_callback(result.data);
          })
          .catch((error) => {
            if (loadingElement) loadingElement.remove();
            console.error("chat_response catch :", error);
            addAIMessage("ì—°ê²°ì´ ì›í™œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
            sendBtn.disabled = false;
            chatInput.disabled = false;
          });
      }

      // AI ì‘ë‹µ ìš”ì²­ ì½œë°±
      function chat_response_callback(data) {
        addAIMessage(data.answer);

        sendBtn.disabled = false;
        chatInput.disabled = false;
        chatInput.focus();
      }
    </script>
  </body>
</html>
