{% load static %}

<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI ìƒë‹´ - ì •ì±… ì¶”ì²œ ì„œë¹„ìŠ¤</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
    <link rel="stylesheet" href="{% static 'css/chat.css' %}" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="header-top">
          <button class="btn-icon" onclick="goBack()">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="19" y1="12" x2="5" y2="12"></line>
              <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
          </button>
          <div style="flex: 1; text-align: center">
            <h2 style="margin: 0">AI ìƒë‹´</h2>
            <p style="margin: 0; font-size: 12px; color: #a0aec0">
              24ì‹œê°„ ì–¸ì œë‚˜ ìƒë‹´ ê°€ëŠ¥
            </p>
          </div>
          <div style="width: 44px"></div>
        </div>
      </div>

      <div class="chat-container">
        <div id="chatMessages" class="chat-messages"></div>

        <div class="quick-questions" id="quickQuestions">
          <button
            class="quick-question-btn"
            onclick="sendMessage('ì²­ë…„ ì›”ì„¸ ì§€ì›ì‚¬ì—…ì— ëŒ€í•´ ì•Œë ¤ì¤˜')"
          >
            ì²­ë…„ ì›”ì„¸ ì§€ì›ì‚¬ì—…
          </button>
          <button
            class="quick-question-btn"
            onclick="sendMessage('ë‚˜ì´ 25ì„¸ì— ë°›ì„ ìˆ˜ ìˆëŠ” ì •ì±…ì€?')"
          >
            ë‚˜ì´ë³„ ì •ì±…
          </button>
          <button
            class="quick-question-btn"
            onclick="sendMessage('ì·¨ì—… ê´€ë ¨ ì •ì±… ì¶”ì²œí•´ì¤˜')"
          >
            ì·¨ì—… ì •ì±…
          </button>
          <button
            class="quick-question-btn"
            onclick="sendMessage('ì‹ ì²­ ë°©ë²•ì´ ê¶ê¸ˆí•´')"
          >
            ì‹ ì²­ ë°©ë²•
          </button>
        </div>

        <div class="chat-input-wrapper">
          <form class="chat-input-form" onsubmit="handleSubmit(event)">
            <input
              type="text"
              id="chatInput"
              class="chat-input"
              placeholder="ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”..."
              autocomplete="off"
            />
            <button type="submit" id="sendBtn" class="chat-send-btn">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="white"
                stroke-width="2"
              >
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
              </svg>
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Floating Home Button -->
    <button
      id="floatingHome"
      class="floating-home"
      onclick="window.location.href = 'index.html'"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        <polyline points="9 22 9 12 15 12 15 22"></polyline>
      </svg>
    </button>

    <script src="{% static 'js/data.js' %}"></script>
    <script src="{% static 'js/main.js' %}"></script>
    <script>
      const chatMessages = document.getElementById("chatMessages");
      const chatInput = document.getElementById("chatInput");
      const sendBtn = document.getElementById("sendBtn");
      const quickQuestions = document.getElementById("quickQuestions");

      // í™”ë©´ ì²˜ìŒ ì—´ì—ˆì„ ë•Œ ë©”ì„¸ì§€ ë…¸ì¶œ ì²˜ë¦¬
      document.addEventListener("DOMContentLoaded", () => {
        loadChatHistory();
        chatInput.focus();
      });

      // ê³¼ê±° ëŒ€í™” ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°
      function loadChatHistory() {
        fetch(`/chat/api/chat_init`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((result) => {
            console.log("loadChatHistory", result);
            loadChatHistory_callback(result.data);
          })
          .catch((error) => {
            console.error("loadChatHistory catch :", error);
          });
      }

      // ê³¼ê±° ëŒ€í™” ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸° ì½œë°±
      function loadChatHistory_callback(data) {
        // ëŒ€í™” ë‚´ì—­ì´ ì—†ìœ¼ë©´ í™˜ì˜ ë©”ì„¸ì§€ ì¶œë ¥
        if (!data || data.length === 0) {
          const welcomeMessage =
            "ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹\nì •ì±… ì¶”ì²œ AI ìƒë‹´ì‚¬ì…ë‹ˆë‹¤.\n\nê¶ê¸ˆí•˜ì‹  ì •ì±…ì´ë‚˜ ì‹ ì²­ ë°©ë²•ì— ëŒ€í•´ ë¬¼ì–´ë³´ì„¸ìš”!";
          addAIMessage(welcomeMessage);
        }
      }

      // í™”ë©´ì— ë©”ì„¸ì§€ ë…¸ì¶œ (ë©”ì„¸ì§€, ì‚¬ìš©ì ì—¬ë¶€)
      function addMessage(text, isUser) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `chat-message ${isUser ? "user" : "ai"}`;

        messageDiv.innerHTML = `
        <div class="chat-avatar ${isUser ? "user" : "ai"}">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            ${
              isUser
                ? '<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle>'
                : '<path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"></path>'
            }
          </svg>
        </div>
        <div class="chat-bubble ${isUser ? "user" : "ai"}">${text.replace(/\n/g, "<br>")}</div>
      `;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function addAIMessage(text) {
        addMessage(text, false);
      }

      function addUserMessage(text) {
        addMessage(text, true);
      }

      // ì‚¬ìš©ìê°€ ë©”ì„¸ì§€ ì „ì†¡
      function handleSubmit(event) {
        event.preventDefault(); // í™”ë©´ ìƒˆë¡œê³ ì¹¨ ë°©ì§€

        // ì‚¬ìš©ì ì…ë ¥ê°’ ì—†ìœ¼ë©´ return
        const text = chatInput.value.trim();
        if (!text) return;

        // ë¹ ë¥¸ ì§ˆë¬¸ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        quickQuestions.style.display = "none";

        // ì‚¬ìš©ì ì…ë ¥ì°½ ê³µë°±ì²˜ë¦¬
        chatInput.value = "";

        // ì‚¬ìš©ì ë©”ì„¸ì§€ í™”ë©´ì— ì¶”ê°€
        addUserMessage(text);

        // ì…ë ¥ ë¹„í™œì„±í™”
        sendBtn.disabled = true;
        chatInput.disabled = true;

        // ì‘ë‹µ ê°€ì ¸ì˜¤ê¸°
        fetch(`/chat/api/chat_response`, {
          method: "POST",
          body: JSON.stringify({ message: text }),
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((result) => {
            console.log("chat_response", result);
            chat_response_callback(result.data);
          })
          .catch((error) => {
            console.error("insertMessage catch :", error);
          });
      }

      // AI ì‘ë‹µ ìš”ì²­ ì½œë°±
      function chat_response_callback(data) {
        addAIMessage(data.answer);

        sendBtn.disabled = false;
        chatInput.disabled = false;
        chatInput.focus();
      }
    </script>
  </body>
</html>
